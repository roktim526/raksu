<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rajshahi University Central Student Union</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --light: #212529;
            --dark: #f8f9fa;
            --gray: #adb5bd;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            transition: var(--transition);
            line-height: 1.6;
            padding-bottom: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--box-shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: left;
            height: 48px;
            min-width: 48px;
            max-width: 160px;
            padding: 4px 5px;
        }

        .logo img {
            height: 40px;
            width: auto;
            max-width: 140px;
            object-fit: contain;
            display: block;
            padding-right: 3px;
        }

        /* Responsive: shrink logo on small screens */
        @media (max-width: 600px) {
            .logo {
                height: 36px;
                max-width: 130px;
            }
            .logo img {
                height: 28px;
                max-width: 100px;
            }
        }

        .nav-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-toggle, .language-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50px;
            padding: 5px 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }

        .theme-toggle:hover, .language-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .search-container {
            margin: 20px 0;
            position: relative;
        }

        .search-bar {
            width: 100%;
            padding: 12px 20px;
            border-radius: 50px;
            border: 1px solid var(--gray);
            background-color: var(--light);
            color: var(--dark);
            font-size: 1rem;
            box-shadow: var(--box-shadow);
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--primary);
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--light);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .autocomplete-item {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .autocomplete-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .filter-select {
            width: 100%;
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray);
            background-color: var(--light);
            color: var(--dark);
        }

        .candidate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .position-header {
            grid-column: 1 / -1;
            margin: 20px 0 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            font-size: 1.5rem;
            color: var(--primary);
        }

        .candidate-card {
            background-color: var(--light);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .candidate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .candidate-image-container {
            width: 100%;
            height: 430px;
            overflow: hidden;
            position: relative;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .candidate-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-placeholder {
            font-size: 3rem;
            color: #aaa;
        }

        .candidate-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .candidate-name {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .candidate-details {
            color: var(--gray);
            margin-bottom: 10px;
            font-size: 0.9rem;
            flex-grow: 1;
        }

        .candidate-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .favorite-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .favorite-btn.active {
            color: gold;
        }

        .view-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 5px 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .view-btn:hover {
            background-color: var(--secondary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow: auto;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--light);
            margin: auto;
            border-radius: var(--border-radius);
            max-width: 600px;
            position: relative;
            box-shadow: var(--box-shadow);
        }

        .modal-header {
            padding: 15px 20px;
            background-color: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-image-container {
            width: 100%;
            max-height: 300px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            border-radius: var(--border-radius);
        }

        .modal-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
        }

        .modal-bio {
            line-height: 1.6;
        }

        .favorites-section {
            margin: 40px 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .save-btn {
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }

        .save-btn:hover {
            opacity: 0.9;
        }

        .clear-favorites {
            background-color: var(--warning);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }

        .clear-favorites:hover {
            opacity: 0.9;
        }

        .no-candidates {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--gray);
            font-style: italic;
        }

        footer {
            background-color: var(--primary);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 40px;
        }

        .hide-voter-no {
            display: none !important;
        }

        /* Voting widget styles */
        .vote-widget {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-right: 10px;
            min-width: 50px;
            gap: 2px;
        }
        .vote-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background-color: #f1f2f3;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin: 2px 0;
            font-size: 1.1rem;
        }
        .vote-btn.upvote.active { background-color: #46a049; color: #fff; }
        .vote-btn.downvote.active { background-color: #d93025; color: #fff; }
        .vote-score {
            font-size: 16px;
            font-weight: bold;
            margin: 4px 0;
            min-height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .score-positive { color: #46a049; }
        .score-negative { color: #d93025; }
        .score-neutral { color: #666; }
        .rank-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }
        .candidate-card { position: relative; }
        
        /* New vote buttons styling */
        .vote-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .vote-up, .vote-down {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
        }
        
        .vote-up:hover {
            background-color: #46a049;
            transform: scale(1.1);
        }
        
        .vote-down:hover {
            background-color: #d93025;
            transform: scale(1.1);
        }
        
        .vote-counts {
            display: flex;
            justify-content: space-around;
            margin-top: 5px;
            font-weight: bold;
        }
        
        .upvote-count {
            color: #46a049;
        }
        
        .downvote-count {
            color: #d93025;
        }

        @media (max-width: 768px) {
            .nav-toggle {
                display: block;
            }

            .controls {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                right: 0;
                background-color: var(--primary);
                width: 100%;
                padding: 15px;
                box-shadow: var(--box-shadow);
            }

            .controls.show {
                display: flex;
            }

            .filter-group {
                min-width: 100%;
            }

            .modal-content {
                margin: 20px auto;
            }

            .section-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo"><img src="ru_logo.png" alt="RUCSU">রাকসু ২০২৫</div>
                <button class="nav-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="controls">
                    <button class="theme-toggle">
                        <i class="fas fa-moon"></i> Dark Mode
                    </button>
                    <button class="language-toggle">
                        <i class="fas fa-language"></i> বাংলা
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="search-container">
            <input type="text" class="search-bar" placeholder="Search by name or ballot number...">
            <div class="autocomplete-list"></div>
        </div>

        <div class="filter-controls">
            <div class="filter-group">
                <label class="filter-label">Position</label>
                <select class="filter-select" id="position-filter">
                    <option value="all">All Positions</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Central/Senate/Hall</label>
                <select class="filter-select" id="central-senate-filter">
                    <option value="all">All</option>
                </select>
            </div>            
            <div class="filter-group">
                <label class="filter-label">Hall</label>
                <select class="filter-select" id="hall-filter">
                    <option value="all">All Halls</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Panel</label>
                <select class="filter-select" id="panel-filter">
                    <option value="all">All</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Sort By</label>
                <select class="filter-select" id="sort-by">
                    <option value="ballot">Ballot Number</option>
                    <option value="name">Name</option>
                </select>
            </div>

          
        </div>
        <!-- Voting Statistics -->
        <div class="stats" style="margin-bottom:40px;">
            <h3>Voting Statistics</h3>
            <div class="stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;">
                <div class="stat-item">
                    <div id="totalVotes" class="stat-value">0</div>
                    <div class="stat-label">Total Votes</div>
                </div>
                <div class="stat-item">
                    <div id="totalCandidates" class="stat-value">0</div>
                    <div class="stat-label">Candidates</div>
                </div>
                <div class="stat-item">
                    <div id="topScore" class="stat-value">0</div>
                    <div class="stat-label">Highest Score</div>
                </div>
            </div>
        </div>

        <div class="candidate-grid" id="candidate-container">
            <!-- Candidates will be dynamically inserted here -->
        </div>
        
        

        <div class="favorites-section">
            <div class="section-header">
                <h2>Your Favorites</h2>
                <div>
                    <button class="save-btn" id="save-favorites">
                        <i class="fas fa-download"></i> Save as Image
                    </button>
                    <button class="clear-favorites" id="clear-favorites">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>
            <div class="candidate-grid" id="favorites-container">
                <!-- Favorite candidates will be displayed here -->
            </div>
        </div>
    </main>

    <div class="modal" id="candidate-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Candidate Name</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-image-container" id="modal-image-container">
                    <i class="fas fa-user image-placeholder" id="modal-image-placeholder"></i>
                    <img src="" alt="Candidate Image" class="modal-image" id="modal-image" style="display: none;">
                </div>
                <div class="modal-bio" id="modal-bio">
                    <!-- Candidate bio will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>© 2025 Student Election Portal | Made for students, by students</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDD8A7JBnfigLO9JbBm6mB1sm-5q7-cZdY",
            authDomain: "rucsu2025.firebaseapp.com",
            databaseURL: "https://rucsu2025-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rucsu2025",
            storageBucket: "rucsu2025.firebasestorage.app",
            messagingSenderId: "996980468587",
            appId: "1:996980468587:web:e3959809befddc776a3a2e",
            measurementId: "G-ZY8WVQTVB9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Function to generate random numbers
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Function to update votes for all candidates
        async function updateAllVotes() {
            const dbRef = ref(db);
            try {
                const snapshot = await get(child(dbRef, "rucsu"));
                if (snapshot.exists()) {
                    const candidates = snapshot.val();
                    
                    const updates = {};
                    
                    candidates.forEach((candidate, index) => {
                        const randomUpvote = getRandomInt(0, 5);
                        const randomDownvote = getRandomInt(0, 1);
                        
                        updates[`rucsu/${index}/upvotes`] = candidate.upvotes + randomUpvote;
                        updates[`rucsu/${index}/downvotes`] = candidate.downvotes + randomDownvote;
                    });
                    
                    await update(ref(db), updates);
                    console.log('All votes updated automatically');
                    
                    // Refresh the display
                    readCandidates();
                }
            } catch (error) {
                console.error("Error updating votes:", error);
            }
        }

        // DOM Elements
        const candidateContainer = document.getElementById('candidate-container');
        const favoritesContainer = document.getElementById('favorites-container');
        const searchBar = document.querySelector('.search-bar');
        const autocompleteList = document.querySelector('.autocomplete-list');
        const positionFilter = document.getElementById('position-filter');
        const hallFilter = document.getElementById('hall-filter');
        const panelFilter = document.getElementById('panel-filter');
        const sortBy = document.getElementById('sort-by');
        const themeToggle = document.querySelector('.theme-toggle');
        const languageToggle = document.querySelector('.language-toggle');
        const navToggle = document.querySelector('.nav-toggle');
        const controls = document.querySelector('.controls');
        const modal = document.getElementById('candidate-modal');
        const modalClose = document.querySelector('.modal-close');
        const modalTitle = document.getElementById('modal-title');
        const modalImageContainer = document.getElementById('modal-image-container');
        const modalImage = document.getElementById('modal-image');
        const modalImagePlaceholder = document.getElementById('modal-image-placeholder');
        const modalBio = document.getElementById('modal-bio');
        const saveFavoritesBtn = document.getElementById('save-favorites');
        const clearFavoritesBtn = document.getElementById('clear-favorites');
        const centralSenateFilter = document.getElementById('central-senate-filter');

        // State management
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let currentLanguage = 'english';
        let currentTheme = 'light';
        let candidates = [];
        let currentFilters = {
            position: 'all',
            hall: 'all',
            panel: 'all',
            centralSenate: 'all',
            sortBy: 'ballot'
        };

        // Function to save current filter state
        function saveFilterState() {
            currentFilters = {
                position: positionFilter.value,
                hall: hallFilter.value,
                panel: panelFilter.value,
                centralSenate: centralSenateFilter.value,
                sortBy: sortBy.value
            };
        }

        // Function to restore filter state
        function restoreFilterState() {
            positionFilter.value = currentFilters.position;
            hallFilter.value = currentFilters.hall;
            panelFilter.value = currentFilters.panel;
            centralSenateFilter.value = currentFilters.centralSenate;
            sortBy.value = currentFilters.sortBy;
        }

        // Function to check if an image URL is valid and loadable
        function isValidImageUrl(url) {
            // Check if URL is a Facebook URL (which won't load directly)
            if (url.includes('facebook.com') || url.includes('fb.com')) {
                return false;
            }
            
            // Check if URL is a placeholder or invalid
            if (!url || url === '#' || url === '' || url === 'N/A') {
                return false;
            }
            
            // Check if URL has an image extension
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
            const hasImageExtension = imageExtensions.some(ext => url.toLowerCase().includes(ext));
            
            return hasImageExtension;
        }

        // Initialize the page
        function init() {
            setupEventListeners();
            readCandidates();
            
            // Start automatic vote updates every 1 seconds
            setInterval(updateAllVotes, 1000);
        }

        // Function to display candidates from Firebase
        async function readCandidates() {
            // Save current filter state before reloading
            saveFilterState();

            const dbRef = ref(db);
            try {
                const snapshot = await get(child(dbRef, "rucsu"));
                if (snapshot.exists()) {
                    candidates = snapshot.val();
                    populateFilters();

                    // Restore filter state after populating filters
                    restoreFilterState();

                    renderCandidates();
                    renderFavorites();
                    updateStats();
                } else {
                    candidateContainer.innerHTML = '<div class="no-candidates">No data found!</div>';
                }
            } catch (error) {
                console.error("Error reading data:", error);
                candidateContainer.innerHTML = '<div class="no-candidates">Error loading data!</div>';
            }
        }

        // Populate filter dropdowns with unique values from candidates
        function populateFilters() {
            // Clear existing options
            positionFilter.innerHTML = '<option value="all">All Positions</option>';
            hallFilter.innerHTML = '<option value="all">All Halls</option>';
            panelFilter.innerHTML = '<option value="all">All</option>';
            centralSenateFilter.innerHTML = '<option value="all">All</option>';

            // Get unique values from candidates
            const centralSenateTypes = [...new Set(candidates.map(c => c["rucsu"]))].filter(t => t && t !== 'N/A');
            const positions = [...new Set(candidates.map(c => c.position))].filter(p => p);
            const halls = [...new Set(candidates.map(c => c.hall))].filter(h => h && h !== 'N/A');
            const panels = [...new Set(candidates.map(c => c['Panel']))].filter(p => p && p !== 'N/A');

            // Populate Central/Senate filter
            centralSenateTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                centralSenateFilter.appendChild(option);
            });

            // Populate position filter
            positions.forEach(position => {
                const option = document.createElement('option');
                option.value = position;
                option.textContent = position;
                positionFilter.appendChild(option);
            });
            
            // Populate hall filter
            halls.forEach(hall => {
                const option = document.createElement('option');
                option.value = hall;
                option.textContent = hall;
                hallFilter.appendChild(option);
            });
            
            // Populate panel filter
            panels.forEach(panel => {
                const option = document.createElement('option');
                option.value = panel;
                option.textContent = panel;
                panelFilter.appendChild(option);
            });
        }

        // Render candidates based on filters
        function renderCandidates() {
            const centralSenateValue = centralSenateFilter.value;
            const positionValue = positionFilter.value;
            const hallValue = hallFilter.value;
            const panelValue = panelFilter.value;
            const searchValue = searchBar.value.toLowerCase();
            const sortValue = sortBy.value;
            
            // Filter candidates
            let filteredCandidates = candidates.filter(candidate => {
                const matchesCentralSenate = centralSenateValue === 'all' || candidate["rucsu"] === centralSenateValue;
                const matchesPosition = positionValue === 'all' || candidate.position === positionValue;
                const matchesHall = hallValue === 'all' || candidate.hall === hallValue;
                const matchesPanel = panelValue === 'all' || candidate['Panel'] === panelValue;
                const matchesSearch = searchValue === '' ||
                    candidate.name.toLowerCase().includes(searchValue) ||
                    candidate.ballot_no.toString().includes(searchValue);
                
                return matchesCentralSenate && matchesPosition && matchesHall && matchesPanel && matchesSearch;
            });
            
            // Sort by score (ranking), then fallback to name/ballot
            filteredCandidates.sort((a, b) => {
                const scoreDiff = getScore(b) - getScore(a);
                if (scoreDiff !== 0) return scoreDiff;
                if (sortValue === 'name') return a.name.localeCompare(b.name);
                return a.ballot_no.localeCompare(b.ballot_no);
            });
            
            // Group by position
            const groupedCandidates = {};
            filteredCandidates.forEach(candidate => {
                if (!groupedCandidates[candidate.position]) {
                    groupedCandidates[candidate.position] = [];
                }
                groupedCandidates[candidate.position].push(candidate);
            });
            
            // Render candidates
            candidateContainer.innerHTML = '';
            
            if (filteredCandidates.length === 0) {
                candidateContainer.innerHTML = '<div class="no-candidates">No candidates match your filters</div>';
                return;
            }
            
            Object.keys(groupedCandidates).forEach(position => {
                const positionHeader = document.createElement('h2');
                positionHeader.className = 'position-header';
                positionHeader.textContent = `${position} Candidates`;
                candidateContainer.appendChild(positionHeader);
                
                groupedCandidates[position].forEach((candidate, idx) => {
                    const isFavorite = favorites.includes(candidate.Voter_No);
                    const hasValidImage = isValidImageUrl(candidate.image);
                    const score = getScore(candidate);

                    const candidateCard = document.createElement('div');
                    candidateCard.className = 'candidate-card';
                    candidateCard.innerHTML = `
                        ${idx < 3 ? `<div class="rank-badge">#${idx + 1}</div>` : ''}
                      
                        <div class="candidate-image-container">
                            ${hasValidImage ? 
                                `<img src="${candidate.image}" alt="${candidate.name}" class="candidate-image">` : 
                                `<i class="fas fa-user image-placeholder"></i>`
                            }
                        </div>
                        <div class="candidate-info">
                            <h3 class="candidate-name">${candidate.name}</h3>
                            <p class="candidate-details">
                                Ballot No: ${candidate.ballot_no}<br>
                                <span class="hide-voter-no">Voter No: ${candidate.Voter_No}<br></span>
                                Position: ${candidate.position}<br>
                                ${candidate.hall && candidate.hall !== 'N/A' ? `Hall: ${candidate.hall}<br>` : ''}
                                Type: ${candidate['Panel']}
                            </p>
                            
                            <!-- Vote buttons section -->
                            <div class="vote-buttons">
                                <button class="vote-up" data-id="${candidate.Voter_No}" title="Upvote">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="vote-down" data-id="${candidate.Voter_No}" title="Downvote">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                            </div>
                            <div class="vote-counts">
                                <span class="upvote-count">↑ ${candidate.upvotes}</span>
                                <span class="downvote-count">↓ ${candidate.downvotes}</span>
                            </div>
                            
                            <div class="candidate-actions">
                                <button class="favorite-btn ${isFavorite ? 'active' : ''}" data-id="${candidate.Voter_No}">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button class="view-btn" data-id="${candidate.Voter_No}">View Details</button>
                            </div>
                        </div>
                    `;
                    
                    candidateContainer.appendChild(candidateCard);
                });
            });
        }

        // Render favorite candidates
        function renderFavorites() {
            const favoriteCandidates = candidates.filter(candidate => 
                favorites.includes(candidate.Voter_No)
            );
            
            // Group by position
            const groupedFavorites = {};
            favoriteCandidates.forEach(candidate => {
                if (!groupedFavorites[candidate.position]) {
                    groupedFavorites[candidate.position] = [];
                }
                groupedFavorites[candidate.position].push(candidate);
            });
            
            // Render favorites
            favoritesContainer.innerHTML = '';
            
            if (favoriteCandidates.length === 0) {
                favoritesContainer.innerHTML = '<div class="no-candidates">No favorites yet. Click the star icon on candidates to add them.</div>';
                return;
            }
            
            Object.keys(groupedFavorites).forEach(position => {
                const positionHeader = document.createElement('h3');
                positionHeader.className = 'position-header';
                positionHeader.textContent = `${position}`;
                favoritesContainer.appendChild(positionHeader);
                
                groupedFavorites[position].forEach(candidate => {
                    const hasValidImage = isValidImageUrl(candidate.image);
                    
                    const candidateCard = document.createElement('div');
                    candidateCard.className = 'candidate-card';
                    candidateCard.innerHTML = `
                        <div class="candidate-image-container">
                            ${hasValidImage ? 
                                `<img src="${candidate.image}" alt="${candidate.name}" class="candidate-image">` : 
                                `<i class="fas fa-user image-placeholder"></i>`
                            }
                        </div>
                        <div class="candidate-info">
                            <h3 class="candidate-name">${candidate.name}</h3>
                            <p class="candidate-details">
                                Ballot No: ${candidate.ballot_no}<br>
                                Voter No: ${candidate.Voter_No}<br>
                                Position: ${candidate.position}<br>
                                ${candidate.hall && candidate.hall !== 'N/A' ? `Hall: ${candidate.hall}<br>` : ''}
                                Type: ${candidate['Panel']}
                            </p>
                            
                            <!-- Vote buttons section -->
                            <div class="vote-buttons">
                                <button class="vote-up" data-id="${candidate.Voter_No}" title="Upvote">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="vote-down" data-id="${candidate.Voter_No}" title="Downvote">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                            </div>
                            <div class="vote-counts">
                                <span class="upvote-count">↑ ${candidate.upvotes}</span>
                                <span class="downvote-count">↓ ${candidate.downvotes}</span>
                            </div>
                            
                            <div class="candidate-actions">
                                <button class="favorite-btn active" data-id="${candidate.Voter_No}">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button class="view-btn" data-id="${candidate.Voter_No}">View Details</button>
                            </div>
                        </div>
                    `;
                    
                    favoritesContainer.appendChild(candidateCard);
                });
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            // Filter and search events
            positionFilter.addEventListener('change', renderCandidates);
            hallFilter.addEventListener('change', renderCandidates);
            panelFilter.addEventListener('change', renderCandidates);
            sortBy.addEventListener('change', renderCandidates);
            centralSenateFilter.addEventListener('change', renderCandidates);
            searchBar.addEventListener('input', () => {
                renderCandidates();
                updateAutocomplete();
            });
            
            // Favorite functionality
            document.addEventListener('click', (e) => {
                if (e.target.closest('.favorite-btn')) {
                    const button = e.target.closest('.favorite-btn');
                    const candidateId = button.dataset.id;
                    
                    toggleFavorite(candidateId);
                    renderCandidates();
                    renderFavorites();
                }
                
                if (e.target.closest('.view-btn')) {
                    const button = e.target.closest('.view-btn');
                    const candidateId = button.dataset.id;
                    
                    showCandidateDetails(candidateId);
                }
                
                // Handle upvote button clicks
                if (e.target.closest('.vote-up')) {
                    const button = e.target.closest('.vote-up');
                    const candidateId = button.dataset.id;
                    handleVote(candidateId, 'upvote');
                }
                
                // Handle downvote button clicks
                if (e.target.closest('.vote-down')) {
                    const button = e.target.closest('.vote-down');
                    const candidateId = button.dataset.id;
                    handleVote(candidateId, 'downvote');
                }
            });
            
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);
            
            // Language toggle
            languageToggle.addEventListener('click', toggleLanguage);
            
            // Mobile nav toggle
            navToggle.addEventListener('click', () => {
                controls.classList.toggle('show');
            });
            
            // Modal close
            modalClose.addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Save favorites as image
            saveFavoritesBtn.addEventListener('click', saveFavoritesAsImage);
            
            // Clear favorites
            clearFavoritesBtn.addEventListener('click', clearFavorites);
        }

        // Handle vote button clicks
        async function handleVote(candidateId, voteType) {
            const dbRef = ref(db);
            try {
                const snapshot = await get(child(dbRef, "rucsu"));
                if (snapshot.exists()) {
                    const candidates = snapshot.val();
                    const candidateIndex = candidates.findIndex(c => c.Voter_No === candidateId);

                    if (candidateIndex !== -1) {
                        const updates = {};

                        if (voteType === 'upvote') {
                            updates[`rucsu/${candidateIndex}/upvotes`] = candidates[candidateIndex].upvotes + 1;
                        } else if (voteType === 'downvote') {
                            updates[`rucsu/${candidateIndex}/downvotes`] = candidates[candidateIndex].downvotes + 1;
                        }

                        await update(ref(db), updates);
                        console.log(`${voteType} recorded for candidate ${candidateId}`);

                        // Refresh the display to show updated counts (filters will be preserved)
                        readCandidates();
                    }
                }
            } catch (error) {
                console.error("Error updating vote:", error);
            }
        }

        // Toggle favorite status
        function toggleFavorite(candidateId) {
            const index = favorites.indexOf(candidateId);
            
            if (index === -1) {
                favorites.push(candidateId);
            } else {
                favorites.splice(index, 1);
            }
            
            // Save to localStorage
            localStorage.setItem('favorites', JSON.stringify(favorites));
        }

        // Clear all favorites
        function clearFavorites() {
            if (confirm('Are you sure you want to clear all favorites?')) {
                favorites = [];
                localStorage.setItem('favorites', JSON.stringify(favorites));
                renderCandidates();
                renderFavorites();
            }
        }

        // Show candidate details in modal
        function showCandidateDetails(candidateId) {
            const candidate = candidates.find(c => c.Voter_No === candidateId);
            
            if (candidate) {
                modalTitle.textContent = candidate.name;
                
                // Handle image display in modal
                const hasValidImage = isValidImageUrl(candidate.image);
                if (hasValidImage) {
                    modalImage.src = candidate.image;
                    modalImage.style.display = 'block';
                    modalImagePlaceholder.style.display = 'none';
                } else {
                    modalImage.style.display = 'none';
                    modalImagePlaceholder.style.display = 'block';
                }
                
                modalBio.innerHTML = `
                    <p><strong>Ballot No:</strong> ${candidate.ballot_no}</p>
                    <p><strong>Voter No:</strong> ${candidate.Voter_No}</p>
                    <p><strong>Position:</strong> ${candidate.position}</p>
                    ${candidate.hall && candidate.hall !== 'N/A' ? `<p><strong>Hall:</strong> ${candidate.hall}</p>` : ''}
                    <p><strong>Panel/Individual:</strong> ${candidate['Panel']}</p>
                    <p><strong>Upvotes:</strong> ${candidate.upvotes}</p>
                    <p><strong>Downvotes:</strong> ${candidate.downvotes}</p>
                    <p><strong>Score:</strong> ${getScore(candidate)}</p>
                    ${!hasValidImage ? `<p><small><i class="fas fa-info-circle"></i> Candidate image is not available for direct display</small></p>` : ''}
                `;
                
                modal.style.display = 'block';
            }
        }

        // Toggle between light and dark themes
        function toggleTheme() {
            if (currentTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
                currentTheme = 'dark';
            } else {
                document.documentElement.removeAttribute('data-theme');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
                currentTheme = 'light';
            }
            
            localStorage.setItem('theme', currentTheme);
        }

        // Toggle between languages
        function toggleLanguage() {
            // This would be more comprehensive in a real application
            if (currentLanguage === 'english') {
                languageToggle.innerHTML = '<i class="fas fa-language"></i> English';
                document.querySelector('html').setAttribute('lang', 'bn');
                currentLanguage = 'bangla';
                // In a real app, we would update all text content
            } else {
                languageToggle.innerHTML = '<i class="fas fa-language"></i> বাংলা';
                document.querySelector('html').setAttribute('lang', 'en');
                currentLanguage = 'english';
                // In a real app, we would update all text content
            }
            
            localStorage.setItem('language', currentLanguage);
        }

        // Update autocomplete suggestions
        function updateAutocomplete() {
            const searchValue = searchBar.value.toLowerCase();
            
            if (searchValue.length < 2) {
                autocompleteList.style.display = 'none';
                return;
            }
            
            const matches = candidates.filter(candidate => 
                candidate.name.toLowerCase().includes(searchValue) || 
                candidate.ballot_no.toString().includes(searchValue)
            );
            
            if (matches.length === 0) {
                autocompleteList.style.display = 'none';
                return;
            }
            
            autocompleteList.innerHTML = '';
            matches.forEach(candidate => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = `${candidate.name} (Ballot: ${candidate.ballot_no}, ${candidate.position})`;
                item.addEventListener('click', () => {
                    searchBar.value = candidate.name;
                    autocompleteList.style.display = 'none';
                    renderCandidates();
                });
                autocompleteList.appendChild(item);
            });
            
            autocompleteList.style.display = 'block';
        }

        // Save favorites as image
        function saveFavoritesAsImage() {
            const favoriteCandidates = candidates.filter(candidate =>
                favorites.includes(candidate.Voter_No)
            );

            if (favoriteCandidates.length === 0) {
                alert("No favorites to save!");
                return;
            }

            // Create a temporary container for rendering
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'fixed';
            tempDiv.style.left = '-9999px';
            tempDiv.style.background = '#fff';
            tempDiv.style.padding = '20px';
            tempDiv.style.borderRadius = '8px';
            tempDiv.style.fontFamily = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
            tempDiv.style.color = '#212529';
            tempDiv.innerHTML = `
                <h2 style="color:#4361ee;">Favorite Candidates</h2>
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="border-bottom:1px solid #ccc;padding:8px;text-align:left;">Name</th>
                            <th style="border-bottom:1px solid #ccc;padding:8px;text-align:left;">Position</th>
                            <th style="border-bottom:1px solid #ccc;padding:8px;text-align:left;">Ballot No</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${favoriteCandidates.map(c => `
                            <tr>
                                <td style="padding:8px;">${c.name}</td>
                                <td style="padding:8px;">${c.position}</td>
                                <td style="padding:8px;">${c.ballot_no}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.body.appendChild(tempDiv);

            // Wait for DOM to render
            setTimeout(() => {
                html2canvas(tempDiv).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'favorites.png';
                    link.href = canvas.toDataURL();
                    link.click();
                    document.body.removeChild(tempDiv);
                }).catch(err => {
                    alert("Failed to save image: " + err);
                    document.body.removeChild(tempDiv);
                });
            }, 100);
        }

        // Calculate score for a candidate
        function getScore(candidate) {
            return candidate.upvotes - candidate.downvotes;
        }

        // Update statistics
        function updateStats() {
            if (candidates.length === 0) return;
            
            const totalVotes = candidates.reduce((sum, candidate) => sum + candidate.upvotes + candidate.downvotes, 0);
            const totalCandidates = candidates.length;
            const topScore = Math.max(...candidates.map(candidate => getScore(candidate)));
            
            document.getElementById('totalVotes').textContent = totalVotes;
            document.getElementById('totalCandidates').textContent = totalCandidates;
            document.getElementById('topScore').textContent = topScore;
        }

        // Initialize the application
        init();

        // Check for saved theme and language preferences
        const savedTheme = localStorage.getItem('theme');
        const savedLanguage = localStorage.getItem('language');
        
        if (savedTheme === 'dark') {
            toggleTheme();
        }
        
        if (savedLanguage === 'bangla') {
            toggleLanguage();
        }
    </script>
</body>
</html>
